name: "Export Azure Retail API Prices"

on:
  schedule:
    # Run daily at 6 AM UTC to get fresh pricing data
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering of the workflow

concurrency:
  group: export-prices
  cancel-in-progress: false

jobs:
  export-prices:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Export Azure prices to CSV
      run: |
        poetry run python -c "
        import api.azureapi as azureapi
        import os
        
        # Export all prices in USD
        print('Starting Azure price export...')
        export_df = azureapi.get_prices('USD')
        
        # Use consistent filename for both releases
        filename = 'azure-retail-prices-usd.csv'
        
        # Export to CSV
        export_df.to_csv(filename, index=False)
        print(f'Exported {len(export_df)} price records to {filename}')
        
        # Set output for GitHub Actions
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f'FILENAME={filename}\n')
            f.write(f'EXPORT_COUNT={len(export_df)}\n')
        "

    - name: Export FX rates
      run: |
        poetry run python -c "
        import api.azureapi as azureapi
        import os
        
        # Calculate and export FX rates
        print('Starting FX rate calculation...')
        
        # List of common currencies available in Azure Retail Prices API
        target_currencies = [
            'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'CNY', 'INR',
            'BRL', 'KRW', 'SEK', 'NOK', 'DKK', 'NZD', 'RUB', 'ZAR'
        ]
        
        # MeterId to use for FX rate comparison
        # This specific meter ensures consistent price comparison across currencies
        meter_id = '5daea80f-04ac-5385-86f0-b263d23becd2'
        
        fx_df = azureapi.calculate_fx_rates(
            base_currency='USD',
            target_currencies=target_currencies,
            results_filter=f\"\$filter=meterId eq '{meter_id}'\"
        )
        
        # Use consistent filename for FX rates
        fx_filename = 'azure-fxrates-usd.csv'
        
        # Export to CSV
        fx_df.to_csv(fx_filename, index=False)
        print(f'Exported {len(fx_df)} FX rates to {fx_filename}')
        
        # Set output for GitHub Actions
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f'FX_FILENAME={fx_filename}\n')
            f.write(f'FX_COUNT={len(fx_df)}\n')
        "

    - name: Upload CSV as artifact
      uses: actions/upload-artifact@v4
      with:
        name: azure-prices-${{ steps.date.outputs.date }}
        path: |
          ${{ env.FILENAME }}
          ${{ env.FX_FILENAME }}
        retention-days: 90

    - name: Create Dated Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create dated release with both CSV files
        gh release create "prices-${{ steps.date.outputs.date }}" \
          "${{ env.FILENAME }}" \
          "${{ env.FX_FILENAME }}" \
          --title "Azure Retail Prices - ${{ steps.date.outputs.date }}" \
          --notes "## Azure Retail Prices Export - ${{ steps.date.outputs.date }}
          
        **Export Details:**
        - ðŸ“… **Date**: ${{ steps.date.outputs.date }}
        - ðŸ’° **Currency**: USD
        - ðŸ“Š **Total Records**: ${{ env.EXPORT_COUNT }}
        - ðŸ’± **FX Rates**: ${{ env.FX_COUNT }} currencies
        - ðŸ• **Generated**: Run #${{ github.run_number }}
        
        **Files Available:**
        - **\`${{ env.FILENAME }}\`** - Historical price snapshot for this date
        - **\`${{ env.FX_FILENAME }}\`** - FX rates calculated from USD
        
        **Download:**
        These CSV files contain Azure retail prices in USD format and calculated FX rates for ${{ steps.date.outputs.date }}, suitable for:
        - Cost analysis and planning
        - Price comparison studies  
        - Business intelligence and reporting
        - Academic research
        - Currency conversion and multi-currency reporting
        
        **File Format:** CSV with headers
        **Update Frequency:** Daily (automated)
        
        > ðŸ’¡ **Tip**: For the most current prices, use the [latest release](https://github.com/${{ github.repository }}/releases/tag/latest)."

    - name: Create/Update Latest Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Delete existing latest release if it exists
        gh release delete latest --yes 2>/dev/null || echo "No existing latest release found"
        
        # Create new latest release with both CSV files
        gh release create "latest" \
          "${{ env.FILENAME }}" \
          "${{ env.FX_FILENAME }}" \
          --title "Azure Retail Prices - Latest" \
          --notes "## Azure Retail Prices - Latest Export
          
        **Export Details:**
        - ðŸ“… **Last Updated**: ${{ steps.date.outputs.date }}
        - ðŸ’° **Currency**: USD
        - ðŸ“Š **Total Records**: ${{ env.EXPORT_COUNT }}
        - ðŸ’± **FX Rates**: ${{ env.FX_COUNT }} currencies
        - ðŸ• **Generated**: Run #${{ github.run_number }}
        
        **Files Available:**
        - **\`${{ env.FILENAME }}\`** - Always contains the most current prices (updated daily)
        - **\`${{ env.FX_FILENAME }}\`** - FX rates calculated from USD (updated daily)
        
        **Download:**
        These CSV files contain the most current Azure retail prices in USD format and calculated FX rates, suitable for:
        - Cost analysis and planning
        - Price comparison studies  
        - Business intelligence and reporting
        - Academic research
        - Currency conversion and multi-currency reporting
        
        **File Format:** CSV with headers
        **Update Frequency:** Daily (automated)
        
        > ðŸ”„ **Auto-Updated**: This release is automatically overwritten daily with fresh pricing data.
        > 
        > ðŸ“š **Historical Data**: Check [all releases](https://github.com/${{ github.repository }}/releases) for dated historical exports.
        > 
        > ðŸ“– **API Reference**: [Azure Retail Prices API](https://docs.microsoft.com/en-us/rest/api/cost-management/retail-prices/azure-retail-prices)"

    - name: Summary
      run: |
        echo "## ðŸŽ‰ Azure Prices Export Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Price File**: \`${{ env.FILENAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Records**: ${{ env.EXPORT_COUNT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **FX Rate File**: \`${{ env.FX_FILENAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **FX Rates**: ${{ env.FX_COUNT }} currencies" >> $GITHUB_STEP_SUMMARY
        echo "- **Dated Release**: [prices-${{ steps.date.outputs.date }}](https://github.com/${{ github.repository }}/releases/tag/prices-${{ steps.date.outputs.date }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest Release**: [latest](https://github.com/${{ github.repository }}/releases/tag/latest)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Both releases are now available for public download!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Direct Downloads**:" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“… Dated Prices CSV](https://github.com/${{ github.repository }}/releases/download/prices-${{ steps.date.outputs.date }}/${{ env.FILENAME }}) - Historical snapshot for ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“… Dated FX Rates CSV](https://github.com/${{ github.repository }}/releases/download/prices-${{ steps.date.outputs.date }}/${{ env.FX_FILENAME }}) - FX rates for ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ”„ Latest Prices CSV](https://github.com/${{ github.repository }}/releases/download/latest/${{ env.FILENAME }}) - Always current prices (auto-updated)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ”„ Latest FX Rates CSV](https://github.com/${{ github.repository }}/releases/download/latest/${{ env.FX_FILENAME }}) - Always current FX rates (auto-updated)" >> $GITHUB_STEP_SUMMARY